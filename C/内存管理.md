# 内存管理

## 作用域和生命周期

C语言变量的作用域分为：

- 代码块作用域
- 函数作用域
- 文件作用域

### 局部变量

#### 定义

大括号{ }内部定义的变量就是局部变量

#### 特点

- 只有执行到定义变量的这个语句，系统才会给这个变量分配空间
- 当离开大括号，非静态局部变量自动释放
- 局部变量的作用域在当前的{ }，离开此大括号，无法使用此变量
- 内部的作用域可以使用外部作用域的变量
- 普通局部变量也叫自动变量
- 如果不初始化，默认值为随机数
- { }内部的普通局部变量，加不加auto关键字等价
- 就近原则：同名变量执行就近原则
- 不同的大括号中，变量名可以一样

### 静态static局部变量

#### 定义

大括号内部定义的static变量就是静态局部变量

#### 特点

- static局部变量，在编译阶段就会分配空间，函数没有调用前就已经存在
- 离开大括号，static局部变量不会释放空间，只有程序结束，static变量才会自动释放
- static局部变量的作用于在当前大括号，离开当前大括号，无法使用该变量
- 不同的大括号中，static局部变量名可以一样。
- 如果static局部变量不初始化，它的值默认为0
- static局部变量初始化语句，只会执行一次，但是可以赋值多次。
- static局部变量放在data区
- static局部变量只能用常量初始化

### 普通局部变量和静态局部变量区别

1. 内存分配和释放
   - 普通局部变量只有执行到定义变量的语句才分配空间
   - 静态局部变量在编译阶段（函数还没有执行），变量的空间已经分配
   - 普通局部变量离开作用域后，自动释放
   - 静态局部变量只有在整个程序结束后才会释放
2. 初始化
   - 普通局部变量不初始化，值为随机数
   - 静态局部变量不初始化，值为0
   - 静态局部变量初始化语句只执行第一次
   - 静态局部变量只能用常量初始化

### 全局变量

#### 定义

在函数外面定义的变量为全局变量

#### 特点

- 定义了全局变量，任何地方都能使用
- 如果使用变量时，前面找不到此全局变量的定义，需要声明后才能使用
- 声明只是针对全局变量，不是针对局部变量
- 全局变量只能定义一次，可以声明多次
- 全局变量不初始化，默认赋值0
- 全局变量在编译阶段已经分配空间（函数没有执行前），只有在整个程序结束，才自动释放

```c
#include <stdio.h>
/*
函数的声明
使用fun函数时，前面找不到fun函数的定义，需要先声明才能使用
extern可以不写
可以多次声明
*/
extern void fun();

int main(){
	fun();
	return 0;
}

void fun(){
	/*
	全局变量的声明
	声明时，不要赋值
	使用a变量时，前面找不到a的定义，需要声明才能使用
	可以多次声明
	*/
	extern int a;
	printf("a = %d\n",a);
}

int a = 10;
```

#### 全局变量的缺陷

- 只有声明，没有定义，无法给变量赋值
- 如果定义一个全局变量，没有赋值（初始化），无法确定是定义还是声明
- 如果定义一个全局变量，同时初始化，一定是定义
- 定义一个全局变量，建议同时初始化
- 如果声明一个全局变量，建议加extern关键字

#### 全局变量分文件

```c
//main.c文件
#include <stdio.h>

int main(){
	extern void fun();//函数声明
	fun();
	extern int a;//全局变量声明
	extern int b;//全局变量声明
	printf("a = %d, b = %d\n",a,b);
	return 0;
}
//outer.c文件
int a = 10;
int b = 20;
void fun(){
	a = 100;
	b = 200;
}
//main.c  不带声明
#include <stdio.h>
//函数和全局变量声明写在头文件中
#include "head.h"  

int main(){
	fun();
	printf("a = %d, b = %d\n",a,b);
	return 0;
}
//head.h
//头文件只做声明，不要做定义
extern void fun();
extern int a;
extern int b;
```

```bash
//编译的命令
gcc main.c outer.c
```

### 静态static全局变量

### extern全局变量声明

### 全局函数和静态函数

### 总结

## 内存布局

### 内存分区

### 存储类型总结

### 内存操作函数

### 堆区内存分配和释放

## 内存分区代码分析